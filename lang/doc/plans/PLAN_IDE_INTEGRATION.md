# XTC Language Support Implementation

This document describes the language tooling implemented in the `lang/` directory and what remains to be done.

## What's Implemented

### 1. Language Model DSL (`lang/dsl/`)

A Kotlin DSL that defines the complete XTC language model and generates editor support files:

**Source:** `XtcLanguage.kt` - Complete language definition including:
- Keywords (reserved and context-sensitive)
- Operators with precedence and associativity
- Built-in types
- Token patterns for lexical analysis
- AST concept definitions

**Generators:**
| Generator | Output | Purpose |
|-----------|--------|---------|
| `TextMateGenerator` | `xtc.tmLanguage.json` | Syntax highlighting for VS Code, IntelliJ, Sublime |
| `TreeSitterGenerator` | `grammar.js`, `highlights.scm` | Incremental parsing, structural queries |
| `VimGenerator` | `xtc.vim` | Vim syntax highlighting |
| `EmacsGenerator` | `xtc-mode.el` | Emacs major mode |
| `SublimeSyntaxGenerator` | `xtc.sublime-syntax` | Sublime Text highlighting |
| `VSCodeConfigGenerator` | `language-configuration.json` | Bracket matching, comments, folding |

**Generated Files:** See `lang/generated-examples/`

### 2. LSP Server (`lang/lsp-server/`)

A Language Server Protocol implementation providing IDE features:

**Server:** `XtcLanguageServer.kt`, `XtcLanguageServerLauncher.kt`

**Adapter Architecture:**

The LSP server uses a pluggable adapter pattern to support different backends:

```
                     XtcLanguageServer
                            │
                   XtcCompilerAdapter (interface)
                            │
         ┌──────────────────┼──────────────────┐
         │                  │                  │
         ▼                  ▼                  ▼
  MockXtcCompiler-    TreeSitter-      XtcCompilerAdapter-
  Adapter             Adapter          Full
  (regex-based)       (syntax-aware)   (future: semantic)
```

| Adapter | Backend | LSP Feature Coverage | Status |
|---------|---------|----------------------|--------|
| `MockXtcCompilerAdapter` | Regex patterns | ~30% (basic testing) | Implemented |
| `TreeSitterAdapter` | Tree-sitter grammar | ~70% (syntax-level) | Implemented |
| `XtcCompilerAdapterFull` | XTC Compiler | 100% (semantic) | Interface only |

**What Each Adapter Provides:**

| Feature | Mock | Tree-sitter | Compiler |
|---------|------|-------------|----------|
| Syntax highlighting | - | TextMate | TextMate |
| Document symbols | Limited | Full | Full |
| Go-to-definition (same file) | By name | By name | Semantic |
| Go-to-definition (cross-file) | - | - | Full |
| Find references (same file) | By name | By name | Full |
| Completions | Keywords | Keywords + locals | Types + members |
| Syntax errors | - | Full | Full |
| Semantic errors | - | - | Full |
| Hover (signature) | - | Basic | Full types |

**Data Model:** `lang/lsp-server/src/main/kotlin/org/xvm/lsp/model/`
- `CompilationResult` - Compilation output with diagnostics and symbols
- `Diagnostic` - Error/warning/info with location
- `Location` - File position
- `SymbolInfo` - Symbol metadata (name, kind, signature, location)

### 3. IntelliJ Plugin (`lang/intellij-plugin/`)

An IntelliJ IDEA plugin providing XTC support:

- **`XtcLspServerSupportProvider`** - Integrates with LSP4IJ for LSP features
- **`XtcProjectGenerator`** / **`XtcNewProjectWizardStep`** - New Project wizard
- **`XtcRunConfiguration`** / **`XtcRunConfigurationType`** / **`XtcRunConfigurationProducer`** - Run configurations
- **`XtcTextMateBundleProvider`** - TextMate grammar for syntax highlighting
- **`XtcIconProvider`** - XTC file icons

### 4. VS Code Extension (`lang/vscode-extension/`)

A VS Code extension stub with:
- Extension manifest (`package.json`)
- Language configuration
- TextMate grammar inclusion
- LSP client setup (scaffolded)

### 5. Tree-sitter Integration

Full tree-sitter support for fast, incremental parsing:

**Grammar:** Generated by `TreeSitterGenerator` -> `grammar.js`

**Kotlin Bindings:** `lang/lsp-server/src/main/kotlin/org/xvm/lsp/treesitter/`
- `XtcParser` - Parser wrapper
- `XtcTree` - Parse tree
- `XtcNode` - Tree node
- `XtcQueryEngine` - Pattern matching queries
- `XtcQueries` - Predefined queries for declarations, references

## What Remains To Be Done

### Short-term (Complete LSP Features)

1. **Wire up TreeSitterAdapter in LSP server**
   - Currently the server uses MockXtcCompilerAdapter by default
   - Add build-time or runtime adapter selection
   - Test with real XTC files

2. **Implement semantic tokens**
   - Add `textDocument/semanticTokens/full` to LSP server
   - Use tree-sitter or compiler for accurate token types
   - Better than TextMate for semantic highlighting

3. **Complete VS Code extension**
   - Finish LSP client integration
   - Add commands (new project, run, build)
   - Package and test

4. **Polish IntelliJ plugin**
   - Test project wizard with `xtc init`
   - Verify run configurations work
   - Build and test plugin ZIP

### Medium-term (Compiler Integration)

5. **Implement `XtcCompilerAdapterFull`**
   - Extract type information from XTC compiler
   - Provide cross-file go-to-definition
   - Provide semantic error reporting
   - Provide type-aware completions

   Two approaches are documented in the research repo:
   - **Quick Path**: State externalization (~4-6 weeks)
   - **Parallel Path**: Modern rewrite / parallel implementation of needed components (~3 months, recommended)

   See *Internal documentation* for detailed plans.

6. **Hybrid adapter strategy**
   - Use tree-sitter for fast syntax feedback
   - Use compiler adapter for semantic features when available
   - Graceful degradation when compiler is unavailable

### Long-term (Advanced Features)

7. **Refactoring support**
   - Rename symbol
   - Extract method/variable
   - Safe delete

8. **Code actions**
   - Quick fixes for common errors
   - Import organization
   - Generate code (getters, toString, etc.)

9. **Debugging (DAP)**
   - Debug Adapter Protocol integration
   - Breakpoints, stepping, variable inspection

## Architecture Principle

**CLI is source of truth**: IDE plugins shell out to `xtc` CLI commands.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         IDE Plugins (Thin Wrappers)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │   IntelliJ   │  │    VS Code   │  │     Zed     │  │   Eclipse   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘  └──────┬──────┘   │
│         │                 │                 │                 │         │
│         └─────────────────┴─────────────────┴─────────────────┘         │
│                                   │                                     │
│                          (shell out to CLI)                             │
├───────────────────────────────────┼─────────────────────────────────────┤
│                           ┌───────▼───────┐                             │
│                           │   xtc CLI     │                             │
│                           │  init | run   │                             │
│                           │  build | test │                             │
│                           └───────┬───────┘                             │
├───────────────────────────────────┼─────────────────────────────────────┤
│         ┌─────────────────────────┼─────────────────────────┐           │
│         │                         │                         │           │
│  ┌──────▼──────┐          ┌───────▼───────┐         ┌───────▼───────┐   │
│  │ Initializer │          │   Compiler    │         │    Runner     │   │
│  │  (templates)│          │   (xcc)       │         │    (xec)      │   │
│  └─────────────┘          └───────────────┘         └───────────────┘   │
├─────────────────────────────────────────────────────────────────────────┤
│                           ┌───────────────┐                             │
│                           │  LSP Server   │ ◄── IDE language features   │
│                           │ (hover, etc.) │                             │
│                           └───────────────┘                             │
└─────────────────────────────────────────────────────────────────────────┘
```

## Related Documentation

- **[PLAN_TREE_SITTER.md](./PLAN_TREE_SITTER.md)** - Tree-sitter grammar status and development guide
- *Internal documentation* - Comprehensive architecture analysis and compiler modification plans
