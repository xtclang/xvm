# IntelliJ IDEA Build Mode Guide

## TL;DR - Just Use Gradle Mode

**Recommended:** Use Gradle build mode. It's simpler, more reliable, and everything works automatically.

**For Debugging:** You can set breakpoints and debug in Gradle mode exactly the same as IDEA mode. IntelliJ just uses Gradle to compile, then runs your code normally with full debugging support.

Skip to: [Gradle Mode Setup](#gradle-mode-recommended)

## If You Insist on IDEA Mode...

If you absolutely must use IntelliJ IDEA build mode instead of Gradle mode, follow this guide carefully. **Be warned**: IDEA mode requires manual resource generation steps and has known issues.

---

## The Two Problems with IDEA Mode

### Problem 1: IntelliJ Overwrites Settings to Java 6

**Symptom:** After changing build mode preferences, IntelliJ sets bytecode target to Java 6.

**Why:** When you change preferences, IntelliJ doesn't read your Gradle configuration. It just applies its own defaults (Java 6 for "maximum compatibility").

**Fix:** Run this script after changing preferences:

```bash
./fix-idea-settings.sh
```

Then **restart IntelliJ**.

### Problem 2: Resources Not Generated

**Symptom:** `implicit.x` and `build-info.properties` are missing from javatools, causing runtime errors.

**Why:** IntelliJ IDEA mode doesn't run Gradle tasks. The resources are generated by Gradle tasks (`copyEcstasyResources`, `generateBuildInfo`) which never execute.

**Fix:** Before building in IntelliJ, run:

```bash
./gradlew :javatools:prepareIdeaResources
```

Or add it as a "Before Launch" task (see below).

---

## Complete IDEA Mode Setup

### Step 1: Initial Configuration

1. **Ensure Java 25 is installed**
   ```bash
   java -version  # Should show version 25
   export JAVA_HOME=/path/to/java-25
   ```

2. **Generate IntelliJ configuration**
   ```bash
   ./gradlew idea
   ```

3. **Open project in IntelliJ**

4. **Verify Gradle JVM**
   - Preferences â†’ Build Tools â†’ Gradle
   - Gradle JVM: Select **Java 25**

### Step 2: Switch to IDEA Mode

5. **Change build mode** (if you really want to)
   - Preferences â†’ Build Tools â†’ Gradle
   - Build and run using: **IntelliJ IDEA**
   - Run tests using: **IntelliJ IDEA**
   - Click Apply

6. **IntelliJ will overwrite settings to Java 6** ðŸ˜¡

7. **Fix the overwritten settings**
   ```bash
   ./fix-idea-settings.sh
   ```

8. **Restart IntelliJ** (required for settings to take effect)

### Step 3: Configure Resource Generation

9. **Add "Before Launch" task** for javatools run configurations:

   For **any** run configuration that uses javatools:

   a. Run â†’ Edit Configurations

   b. Select your configuration (or create a template)

   c. Click "Before launch" section at bottom

   d. Click **+** â†’ **Run Gradle Task**

   e. Configure:
      - Gradle project: `:javatools`
      - Tasks: `prepareIdeaResources`
      - Click OK

   f. Now your configuration looks like:
      ```
      Before launch:
        1. Build (if needed)
        2. Run Gradle task 'javatools:prepareIdeaResources'
      ```

10. **Apply to all javatools configurations:**

    Create a **Run Configuration Template** to avoid repeating this:

    a. Run â†’ Edit Configurations â†’ Edit Configuration Templates

    b. Select **Application**

    c. Before launch: Add the Gradle task as above

    d. Click OK

    Now all new Application configurations will include the task.

### Step 4: Verify It Works

11. **Test resource generation:**
    ```bash
    ./gradlew :javatools:prepareIdeaResources
    ```

    Should show:
    ```
    âœ… Resources generated for IntelliJ IDEA mode:
      - implicit.x: true
      - build-info.properties: true
      - errors.properties: true
    ```

12. **Build in IntelliJ:**
    - Build â†’ Build Project
    - Check `javatools/build/generated/resources/main/` exists
    - Check it contains `implicit.x` and `build-info.properties`

13. **Run your application**
    - Should not throw "Resource not found" errors

---

## Common Issues with IDEA Mode

### "Resource not found: implicit.x"

**Cause:** Resources weren't generated before build.

**Fix:**
```bash
./gradlew :javatools:prepareIdeaResources
```

Then rebuild in IntelliJ.

### "Bytecode target is 1.6"

**Cause:** IntelliJ overwrote settings when you changed preferences.

**Fix:**
```bash
./fix-idea-settings.sh
```

Restart IntelliJ.

### "Toolchain from executable property does not match javaLauncher"

**Cause:** IntelliJ is using wrong Java version.

**Fix:**
1. File â†’ Project Structure â†’ Project â†’ SDK: Java 25
2. Run configuration â†’ JRE: Java 25

### Resources Generate But Don't Appear in JAR

**Cause:** IntelliJ doesn't copy `build/generated/resources/` to `out/` automatically.

**Fix:** You need to mark it as a resource directory:

1. Right-click `javatools/build/generated/resources/main`
2. Mark Directory as â†’ Resources Root

**OR** just use Gradle mode where this works automatically.

---

## Gradle Mode (Recommended)

Skip all the above pain:

1. **Preferences â†’ Build Tools â†’ Gradle**
   - Build and run using: **Gradle**
   - Run tests using: **Gradle**
   - Gradle JVM: **Java 25**

2. **That's it.** Everything works:
   - âœ… Correct Java version
   - âœ… Resources generated automatically
   - âœ… No manual scripts needed
   - âœ… Same behavior as command line
   - âœ… Full debugging support with breakpoints
   - âœ… Run/Debug configurations work normally (Run â†’ Edit Configurations â†’ Application)

---

## Why IDEA Mode Is Bad

| Issue | IDEA Mode | Gradle Mode |
|-------|-----------|-------------|
| Java version | Must run `fix-idea-settings.sh` after preference changes | Always correct |
| Resources | Must run `prepareIdeaResources` before builds | Automatic |
| Custom tasks | Don't run | Run automatically |
| Configuration cache | N/A | Supported |
| Build consistency | Different from CI/command line | Identical |
| Setup complexity | 13 manual steps | 1 setting |

---

## Script Reference

### `./fix-idea-settings.sh`

Fixes IntelliJ settings after it overwrites them to Java 6.

**When to run:**
- After changing Gradle build mode preferences
- After IntelliJ import/sync
- When you see "bytecode target 1.6" errors

**What it does:**
- Changes `compiler.xml` bytecode target: `1.6` â†’ `25`
- Changes `gradle.xml` delegatedBuild: `false` â†’ `true`
- Changes `gradle.xml` testRunner: `PLATFORM` â†’ `GRADLE`

### `./gradlew :javatools:prepareIdeaResources`

Generates resources for IDEA mode.

**When to run:**
- Before building in IntelliJ IDEA mode
- When you get "Resource not found" errors
- Add as "Before Launch" task to run automatically

**What it does:**
- Runs `copyEcstasyResources` (copies `implicit.x` from lib_ecstasy)
- Runs `generateBuildInfo` (generates `build-info.properties`)
- Creates `build/generated/resources/main/` directory

---

## Recommendations for Gene

**Option A: Use Gradle Mode** (5 minutes setup)
- Preferences â†’ Gradle â†’ Build and run using: Gradle
- Done. Everything works.

**Option B: Use IDEA Mode** (30 minutes setup + ongoing maintenance)
- Follow all 13 steps above
- Run `./fix-idea-settings.sh` after every preference change
- Add "Before Launch" tasks to all configurations
- Deal with occasional resource generation issues
- Different behavior from CI/teammates

**Marcus's Recommendation:** Use Gradle mode. The "speed" benefit of IDEA mode is negligible with Gradle's configuration cache, and you'll save hours of frustration.

---

## Still Having Issues?

1. Check Java version:
   ```bash
   java -version  # Must be 25
   echo $JAVA_HOME  # Must point to Java 25
   ```

2. Run verification script:
   ```bash
   ./.idea/test-intellij-setup.sh
   ```

3. Check IntelliJ settings:
   - File â†’ Project Structure â†’ Project â†’ SDK: Java 25
   - File â†’ Project Structure â†’ Project â†’ Language level: 25
   - Preferences â†’ Gradle â†’ Gradle JVM: Java 25

4. When in doubt, nuke and restart:
   ```bash
   rm -rf .idea/ .gradle/ */build/ */out/
   ./gradlew idea
   # Open in IntelliJ
   # Gradle tool window â†’ Reload All Gradle Projects
   ```

---

## Why This Guide Exists

IntelliJ's IDEA build mode has poor integration with advanced Gradle features:
- Custom resource generation tasks
- Composite builds
- Java toolchains
- Configuration cache

This project uses all of these. Gradle mode handles them correctly. IDEA mode requires workarounds.

If you need IDEA mode for a specific reason (faster incremental compilation, better IDE integration), this guide shows how to make it work. But **most people should just use Gradle mode**.
