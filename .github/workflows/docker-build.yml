#
# GitHub workflow for building and publishing Docker images
#
# This workflow builds multi-platform Docker images (amd64/arm64) and pushes them to GHCR.
# It triggers automatically on master after CI completes, or can be manually triggered.
#
name: Build Docker Images

permissions:
    contents: read
    packages: write
    actions: read

on:
    # Automatic trigger after CI completes on master
    workflow_run:
        workflows: ["VerifyCommit"]
        types: [completed]
        branches: [master]

    # Manual trigger from any branch
    workflow_dispatch:
        inputs:
            skip-tests:
                description: 'Skip Docker image tests'
                type: boolean
                required: false
                default: false
            cleanup:
                description: 'Run Docker package cleanup after build'
                type: boolean
                required: false
                default: true

env:
    # Build configuration pulled from get-versions action
    DOCKER_BASE_IMAGE: ghcr.io/xtclang/xvm
    GH_COMMIT: ${{ github.sha }}
    GH_BRANCH: ${{ github.ref_name }}

jobs:
    compute-tags:
        name: Compute Docker tags
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        outputs:
            version: ${{ steps.versions.outputs.xdk-version }}
            branch-tag: ${{ steps.compute.outputs.branch-tag }}
            tags-json: ${{ steps.compute.outputs.tags-json }}
            is-master: ${{ steps.compute.outputs.is-master }}

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5

            - name: Get versions
              id: versions
              uses: ./.github/actions/get-versions

            - name: Compute tags
              id: compute
              shell: bash
              run: |
                  IS_MASTER=${{ github.ref == 'refs/heads/master' }}
                  VERSION="${{ steps.versions.outputs.xdk-version }}"
                  BRANCH_TAG=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')

                  echo "is-master=$IS_MASTER" >> $GITHUB_OUTPUT
                  echo "branch-tag=$BRANCH_TAG" >> $GITHUB_OUTPUT

                  if [ "$IS_MASTER" = "true" ]; then
                      TAGS='["latest","'$VERSION'","'${{ github.sha }}'"]'
                  else
                      TAGS='["'$BRANCH_TAG'","'${{ github.sha }}'"]'
                  fi

                  echo "tags-json=$TAGS" >> $GITHUB_OUTPUT

                  echo "üè∑Ô∏è Computed Docker metadata:"
                  echo "  Version: $VERSION"
                  echo "  Branch tag: $BRANCH_TAG"
                  echo "  Is master: $IS_MASTER"
                  echo "  Tags: $TAGS"

    docker-build:
        name: Build Docker image (${{ matrix.arch }})
        needs: compute-tags
        runs-on: ${{ matrix.runner }}
        strategy:
            matrix:
                include:
                    - platform: linux/amd64
                      arch: amd64
                      runner: ubuntu-latest
                    - platform: linux/arm64
                      arch: arm64
                      runner: ubuntu-24.04-arm

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5

            - name: Get versions
              id: versions
              uses: ./.github/actions/get-versions

            - name: Setup XVM Build Environment
              uses: ./.github/actions/setup-xvm-build
              with:
                  java-version: ${{ steps.versions.outputs.java-version }}
                  java-distribution: ${{ steps.versions.outputs.java-distribution }}
                  gradle-version: ${{ steps.versions.outputs.gradle-version }}
                  cache-read-only: true
                  enable-debug: false

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Download XDK from snapshot release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Determine the commit we're building for
                  if [ "${{ github.event_name }}" = "workflow_run" ]; then
                      EXPECTED_COMMIT="${{ github.event.workflow_run.head_sha }}"
                      echo "üìå Building for commit from workflow_run: $EXPECTED_COMMIT"
                  else
                      EXPECTED_COMMIT="${{ github.sha }}"
                      echo "üìå Building for commit from manual trigger: $EXPECTED_COMMIT"
                  fi

                  echo "üì• Downloading XDK from snapshot release..."
                  gh release download xdk-latest-snapshot --pattern "xdk-*.zip" --repo ${{ github.repository }}
                  XDK_ZIP=$(find . -name "xdk-*.zip" | head -1)
                  if [ -z "$XDK_ZIP" ]; then
                      echo "‚ùå Failed to download XDK from snapshot release"
                      exit 1
                  fi
                  echo "‚úÖ Downloaded: $(basename "$XDK_ZIP")"

                  # Validate snapshot matches expected commit
                  echo "üîç Validating snapshot release matches expected commit..."
                  RELEASE_INFO=$(gh release view xdk-latest-snapshot --repo ${{ github.repository }} --json body,tagName)
                  RELEASE_COMMIT=$(echo "$RELEASE_INFO" | jq -r '.body' | grep -oP '(?<=\*\*Commit:\*\* )[a-f0-9]{40}' || echo "")

                  if [ -z "$RELEASE_COMMIT" ]; then
                      echo "‚ö†Ô∏è  WARNING: Could not extract commit from release notes"
                      echo "‚ö†Ô∏è  Snapshot may not match expected commit $EXPECTED_COMMIT"
                      echo "‚ö†Ô∏è  Proceeding anyway (manual trigger or old release format)"
                  elif [ "$RELEASE_COMMIT" != "$EXPECTED_COMMIT" ]; then
                      echo "‚ùå ERROR: Snapshot commit mismatch!"
                      echo "   Expected: $EXPECTED_COMMIT"
                      echo "   Got:      $RELEASE_COMMIT"
                      echo ""
                      echo "This usually means another CI run updated the snapshot while this workflow was queued."
                      echo "The snapshot release should match the commit that triggered this workflow."
                      exit 1
                  else
                      echo "‚úÖ Snapshot commit matches: $RELEASE_COMMIT"
                  fi

            - name: Build and push Docker image (${{ matrix.arch }})
              shell: bash
              working-directory: docker
              run: |
                  set -euo pipefail

                  VERSION="${{ needs.compute-tags.outputs.version }}"
                  BASE_TAGS='${{ needs.compute-tags.outputs.tags-json }}'

                  # Generate architecture-specific tags
                  TAGS=$(echo "$BASE_TAGS" | jq -r --arg base "${{ env.DOCKER_BASE_IMAGE }}" --arg arch "${{ matrix.arch }}" '.[] | $base + ":" + . + "-" + $arch')
                  TAG_ARGS=""
                  for tag in $TAGS; do
                      TAG_ARGS="$TAG_ARGS --tag $tag"
                  done

                  echo "üè∑Ô∏è Architecture-specific tags for ${{ matrix.arch }}:"
                  echo "$TAGS"

                  # Copy XDK ZIP to Docker context
                  DIST_ZIP_FILE=$(find ../ -name "xdk-*.zip" | head -1)
                  cp "$DIST_ZIP_FILE" xdk-dist.zip
                  echo "üì¶ Copied: $(basename "$DIST_ZIP_FILE") ‚Üí xdk-dist.zip"

                  # Build and push
                  docker buildx build \
                      --platform ${{ matrix.platform }} \
                      --progress=plain \
                      $TAG_ARGS \
                      --build-arg JAVA_VERSION=${{ steps.versions.outputs.java-version }} \
                      --build-arg DIST_ZIP_URL="xdk-dist.zip" \
                      --label org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                      --label org.opencontainers.image.revision=${{ github.sha }} \
                      --label org.opencontainers.image.version="$VERSION" \
                      --label org.opencontainers.image.source=https://github.com/${{ github.repository }}/tree/${{ github.ref_name }} \
                      --cache-from type=gha,scope=${{ matrix.arch }} \
                      --cache-to type=gha,mode=max,scope=${{ matrix.arch }} \
                      --provenance=false \
                      --output type=registry \
                      .

                  echo "‚úÖ Docker image built and pushed for ${{ matrix.arch }}"

    docker-manifest:
        name: Create multi-platform manifest
        needs: [compute-tags, docker-build]
        runs-on: ubuntu-latest

        steps:
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create and push manifests
              shell: bash
              run: |
                  set -euo pipefail

                  BASE_TAGS='${{ needs.compute-tags.outputs.tags-json }}'

                  echo "Creating multi-platform manifests..."
                  echo "$BASE_TAGS" | jq -r '.[]' | while read base_tag; do
                      manifest_tag="${{ env.DOCKER_BASE_IMAGE }}:$base_tag"
                      echo "Creating: $manifest_tag"

                      docker manifest create $manifest_tag \
                          $manifest_tag-amd64 \
                          $manifest_tag-arm64

                      docker manifest push $manifest_tag
                      echo "‚úÖ Pushed: $manifest_tag"
                  done

                  echo "üéâ All multi-platform manifests created"

    docker-test:
        name: Test Docker images
        needs: [compute-tags, docker-manifest]
        runs-on: ubuntu-latest
        if: ${{ github.event.inputs.skip-tests != 'true' }}

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Test Docker image
              shell: bash
              run: |
                  IMAGE="${{ env.DOCKER_BASE_IMAGE }}:${{ github.sha }}"
                  echo "üß™ Testing Docker image: $IMAGE"

                  # Test basic functionality
                  docker run --rm $IMAGE xec --version
                  docker run --rm $IMAGE xcc --version
                  docker run --rm $IMAGE xtc --version

                  echo "‚úÖ Docker image tests passed"

    docker-cleanup:
        name: Clean up old Docker images
        needs: docker-test
        runs-on: ubuntu-latest
        if: ${{ success() && github.event.inputs.cleanup != 'false' }}

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5

            - name: Get versions
              id: versions
              uses: ./.github/actions/get-versions

            - name: Setup XVM Build Environment
              uses: ./.github/actions/setup-xvm-build
              with:
                  java-version: ${{ steps.versions.outputs.java-version }}
                  java-distribution: ${{ steps.versions.outputs.java-distribution }}
                  gradle-version: ${{ steps.versions.outputs.gradle-version }}
                  cache-read-only: true
                  enable-debug: false

            - name: Clean up Docker packages
              run: |
                  echo "üßπ Running Docker package cleanup..."
                  ./gradlew ${{ steps.versions.outputs.gradle-options }} cleanImages -PkeepCount=10
                  echo "‚úÖ Cleanup completed"

    summary:
        name: Workflow summary
        needs: [compute-tags, docker-cleanup]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Generate summary
              run: |
                  echo "### üê≥ Docker Build Workflow" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version:** ${{ needs.compute-tags.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Images published:**" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "${{ env.DOCKER_BASE_IMAGE }}:${{ needs.compute-tags.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "${{ env.DOCKER_BASE_IMAGE }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ needs.compute-tags.outputs.is-master }}" = "true" ]; then
                      echo "${{ env.DOCKER_BASE_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo '```' >> $GITHUB_STEP_SUMMARY
