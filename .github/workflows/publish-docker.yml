#
# GitHub workflow for building and publishing Docker images
#
# This workflow builds multi-platform Docker images (amd64/arm64) and pushes them to GHCR.
# It triggers automatically on master after CI completes, or can be manually triggered.
#
name: Build Docker Images

permissions:
    contents: read
    packages: write
    actions: read

on:
    # AUTOMATIC TRIGGERS DISABLED FOR TESTING
    # Uncomment the following lines to enable automatic publishing after CI:
    # workflow_run:
    #     workflows: ["VerifyCommit"]
    #     types: [completed]

    # Manual trigger from any branch
    workflow_dispatch:
        inputs:
            ci-run-id:
                description: 'CI run ID to download artifact from (required for manual trigger)'
                required: true
            skip-tests:
                description: 'Skip Docker image tests'
                type: boolean
                required: false
                default: false
            cleanup:
                description: 'Run Docker package cleanup after build'
                type: boolean
                required: false
                default: true

env:
    # Build configuration pulled from get-versions action
    DOCKER_BASE_IMAGE: ghcr.io/xtclang/xvm
    GH_COMMIT: ${{ github.sha }}
    GH_BRANCH: ${{ github.ref_name }}

jobs:
    compute-tags:
        name: Compute Docker tags
        runs-on: ubuntu-latest
        # Only run if:
        # - Manual trigger, OR
        # - CI succeeded AND (master branch OR manually dispatched CI with test-publishing=true)
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event.workflow_run.conclusion == 'success' &&
             (github.event.workflow_run.head_branch == 'master' ||
              (github.event.workflow_run.event == 'workflow_dispatch' &&
               github.event.workflow_run.inputs.test-publishing == 'true')))
        outputs:
            version: ${{ steps.versions.outputs.xdk-version }}
            branch-tag: ${{ steps.compute.outputs.branch-tag }}
            tags-json: ${{ steps.compute.outputs.tags-json }}
            is-master: ${{ steps.compute.outputs.is-master }}

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1
                  show-progress: true

            - name: Setup XVM Project
              id: versions
              uses: ./.github/actions/setup-xvm-project
              with:
                  setup-build: false  # Only need version info for tag computation

            - name: Compute tags
              id: compute
              shell: bash
              run: |
                  IS_MASTER=${{ github.ref == 'refs/heads/master' }}
                  VERSION="${{ steps.versions.outputs.xdk-version }}"
                  BRANCH_TAG=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')

                  echo "is-master=$IS_MASTER" >> $GITHUB_OUTPUT
                  echo "branch-tag=$BRANCH_TAG" >> $GITHUB_OUTPUT

                  if [ "$IS_MASTER" = "true" ]; then
                      TAGS='["latest","'$VERSION'","'${{ github.sha }}'"]'
                  else
                      TAGS='["'$BRANCH_TAG'","'${{ github.sha }}'"]'
                  fi

                  echo "tags-json=$TAGS" >> $GITHUB_OUTPUT

                  echo "üè∑Ô∏è Computed Docker metadata:"
                  echo "  Version: $VERSION"
                  echo "  Branch tag: $BRANCH_TAG"
                  echo "  Is master: $IS_MASTER"
                  echo "  Tags: $TAGS"

    docker-build:
        name: Build Docker image (${{ matrix.arch }})
        needs: compute-tags
        runs-on: ${{ matrix.runner }}
        strategy:
            matrix:
                include:
                    - platform: linux/amd64
                      arch: amd64
                      runner: ubuntu-latest
                    - platform: linux/arm64
                      arch: arm64
                      runner: ubuntu-24.04-arm

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1
                  show-progress: true

            - name: Setup XVM Project
              id: versions
              uses: ./.github/actions/setup-xvm-project
              with:
                  setup-build: true
                  cache-read-only: true  # Reuse cache from CI build
                  enable-debug: false

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine commit and run ID
              id: commit
              shell: bash
              run: |
                  # Use workflow_run commit if triggered automatically
                  if [ "${{ github.event_name }}" = "workflow_run" ]; then
                      GH_COMMIT="${{ github.event.workflow_run.head_sha }}"
                      RUN_ID="${{ github.event.workflow_run.id }}"
                      echo "üìå Using commit from workflow_run: $GH_COMMIT (run: $RUN_ID)"
                  # Use manual input (required for manual trigger)
                  else
                      RUN_ID="${{ github.event.inputs.ci-run-id }}"
                      # Get commit from the specified run
                      GH_COMMIT=$(gh api /repos/${{ github.repository }}/actions/runs/$RUN_ID --jq '.head_sha')
                      echo "üìå Using CI run from input: $RUN_ID (commit: $GH_COMMIT)"
                  fi
                  echo "commit=$GH_COMMIT" >> $GITHUB_OUTPUT
                  echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT

            - name: Download XDK build artifact
              uses: actions/download-artifact@v4
              with:
                  name: xdk-dist-${{ steps.commit.outputs.commit }}
                  path: ./artifacts
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  repository: ${{ github.repository }}
                  run-id: ${{ steps.commit.outputs.run-id }}

            - name: Build and push Docker image (${{ matrix.arch }})
              shell: bash
              working-directory: docker
              run: |
                  set -euo pipefail

                  VERSION="${{ needs.compute-tags.outputs.version }}"
                  BASE_TAGS='${{ needs.compute-tags.outputs.tags-json }}'

                  # Generate architecture-specific tags
                  TAGS=$(echo "$BASE_TAGS" | jq -r --arg base "${{ env.DOCKER_BASE_IMAGE }}" --arg arch "${{ matrix.arch }}" '.[] | $base + ":" + . + "-" + $arch')
                  TAG_ARGS=""
                  for tag in $TAGS; do
                      TAG_ARGS="$TAG_ARGS --tag $tag"
                  done

                  echo "üè∑Ô∏è Architecture-specific tags for ${{ matrix.arch }}:"
                  echo "$TAGS"

                  # Copy XDK ZIP to Docker context
                  DIST_ZIP_FILE=$(find ../artifacts -name "xdk-*.zip" | head -1)
                  cp "$DIST_ZIP_FILE" xdk-dist.zip
                  echo "üì¶ Copied: $(basename "$DIST_ZIP_FILE") ‚Üí xdk-dist.zip"

                  # Build and push
                  docker buildx build \
                      --platform ${{ matrix.platform }} \
                      --progress=plain \
                      $TAG_ARGS \
                      --build-arg JAVA_VERSION=${{ steps.versions.outputs.java-version }} \
                      --build-arg DIST_ZIP_URL="xdk-dist.zip" \
                      --label org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                      --label org.opencontainers.image.revision=${{ github.sha }} \
                      --label org.opencontainers.image.version="$VERSION" \
                      --label org.opencontainers.image.source=https://github.com/${{ github.repository }}/tree/${{ github.ref_name }} \
                      --cache-from type=gha,scope=${{ matrix.arch }} \
                      --cache-to type=gha,mode=max,scope=${{ matrix.arch }} \
                      --provenance=false \
                      --output type=registry \
                      .

                  echo "‚úÖ Docker image built and pushed for ${{ matrix.arch }}"

    docker-manifest:
        name: Create multi-platform manifest
        needs: [compute-tags, docker-build]
        runs-on: ubuntu-latest

        steps:
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create and push manifests
              shell: bash
              run: |
                  set -euo pipefail
                  BASE_TAGS='${{ needs.compute-tags.outputs.tags-json }}'
                  echo "Creating multi-platform manifests..."
                  echo "$BASE_TAGS" | jq -r '.[]' | while read base_tag; do
                      manifest_tag="${{ env.DOCKER_BASE_IMAGE }}:$base_tag"
                      echo "Creating: $manifest_tag"
                      docker manifest create $manifest_tag $manifest_tag-amd64 $manifest_tag-arm64
                      docker manifest push $manifest_tag
                      echo "‚úÖ Pushed: $manifest_tag"
                  done
                  echo "üéâ All multi-platform manifests created"

    docker-test:
        name: Test Docker images
        needs: [compute-tags, docker-manifest]
        runs-on: ubuntu-latest
        if: ${{ github.event.inputs.skip-tests != 'true' }}

        steps:
            - name: Fetch Sources
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1
                  show-progress: true

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Test Docker image
              shell: bash
              run: |
                  IMAGE="${{ env.DOCKER_BASE_IMAGE }}:${{ github.sha }}"
                  echo "üß™ Testing Docker image: $IMAGE"

                  # Test basic functionality
                  docker run --rm $IMAGE xec --version
                  docker run --rm $IMAGE xcc --version
                  docker run --rm $IMAGE xtc --version

                  echo "‚úÖ Docker image tests passed"

    docker-cleanup:
        name: Clean up old Docker images
        needs: docker-test
        runs-on: ubuntu-latest
        if: ${{ success() && github.event.inputs.cleanup != 'false' }}

        steps:
            - name: Clean up old Docker image versions (keep 10 newest, preserve latest/master)
              uses: actions/delete-package-versions@v5
              with:
                  package-name: 'xvm'
                  package-type: 'container'
                  min-versions-to-keep: 10
                  ignore-versions: '^(latest|[0-9]+\.[0-9]+\.[0-9]+.*)(-(amd64|arm64))?$'
                  token: ${{ secrets.GITHUB_TOKEN }}

    summary:
        name: Workflow summary
        needs: [compute-tags, docker-cleanup]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Generate summary
              run: |
                  echo "### üê≥ Docker Build Workflow" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version:** ${{ needs.compute-tags.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Images published:**" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "${{ env.DOCKER_BASE_IMAGE }}:${{ needs.compute-tags.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "${{ env.DOCKER_BASE_IMAGE }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ needs.compute-tags.outputs.is-master }}" = "true" ]; then
                      echo "${{ env.DOCKER_BASE_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo '```' >> $GITHUB_STEP_SUMMARY
